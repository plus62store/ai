<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Toko Masker Online - AI Assistant</title>

  <!-- Ionic Core v8 via CDN -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@8/dist/ionic/ionic.esm.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@8/dist/ionic/ionic.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core@8/css/ionic.bundle.css" />
  
  <!-- Include SimpleCart -->
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
  <script src="./simpleCart.js"></script>
  <script src="./main.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .product-grid {
      display: grid;
      gap: 16px;
      padding: 16px;
      grid-template-columns: repeat(2, 1fr);
    }

    @media (min-width: 768px) {
      .product-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .product-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }

    .product-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .product-image {
      width: 100%;
      height: 160px;
      object-fit: cover;
    }

    .product-title {
      font-size: 14px;
      font-weight: 600;
      padding: 8px 12px 4px;
    }

    .product-price {
      font-size: 14px;
      color: #e74c3c;
      padding: 0 12px 8px;
    }

    .product-stock {
      font-size: 12px;
      padding: 0 12px 8px;
    }

    /* Chat Modal Styles */
    .chat-container {
      height: 400px;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #f5f5f5;
    }

    .message {
      margin-bottom: 12px;
      max-width: 80%;
    }

    .user-message {
      margin-left: auto;
      background: #3880ff;
      color: white;
      padding: 10px 14px;
      border-radius: 18px 18px 4px 18px;
    }

    .ai-message {
      margin-right: auto;
      background: white;
      color: #333;
      padding: 10px 14px;
      border-radius: 18px 18px 18px 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .chat-input {
      display: flex;
      padding: 16px;
      border-top: 1px solid #ddd;
      background: white;
    }

    .chat-input ion-input {
      flex: 1;
      margin-right: 12px;
    }

    /* Loading indicator */
    .typing-indicator {
      display: flex;
      padding: 10px 14px;
      background: white;
      border-radius: 18px;
      width: fit-content;
      margin-bottom: 12px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      margin: 0 2px;
      background: #ccc;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <ion-app>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Toko Masker Online</ion-title>
        <ion-buttons slot="end">
          <ion-button id="cart-button">
            <ion-icon name="cart" slot="icon-only"></ion-icon>
            <ion-badge color="danger" id="cart-count">0</ion-badge>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <div class="product-grid" id="productGrid"></div>
    </ion-content>
<span id="footer">DaffaDev</span>
    <!-- AI Chat Modal -->
    <ion-modal trigger="open-chat" id="chat-modal">
      <ion-header>
        <ion-toolbar>
          <ion-title id="chat-title">AI Shopping Assistant</ion-title>
          <ion-buttons slot="end">
            <ion-button onclick="closeChat()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <div class="chat-container">
          <div class="chat-messages" id="chat-messages">
            <!-- Messages will be inserted here -->
          </div>
          <div class="chat-input">
            <ion-input 
              id="chat-input" 
              placeholder="Tanyakan tentang produk..."
              enterkeyhint="send"
            ></ion-input>
            <ion-button id="send-button" onclick="sendMessage()">
              <ion-icon name="send" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ion-modal>

    <!-- Cart Modal -->
    <ion-modal trigger="cart-button" id="cart-modal">
      <ion-header>
        <ion-toolbar>
          <ion-title>Keranjang Belanja</ion-title>
          <ion-buttons slot="end">
            <ion-button onclick="closeCart()">Tutup</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <div id="simpleCart_items" class="simpleCart_items"></div>
        <ion-grid>
          <ion-row>
            <ion-col>
              <ion-button expand="block" color="success" onclick="checkout()">
                Checkout
                <ion-icon name="arrow-forward" slot="end"></ion-icon>
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-content>
    </ion-modal>
  </ion-app>
<script>
  // Konfigurasi SimpleCart
  simpleCart({
    cartColumns: [
      { attr: "name", label: "Produk", view: "link" },
      { attr: "price", label: "Harga", view: "currency" },
      { attr: "warna", label: "Warna", view: "text" },
      { attr: "ukuran", label: "Model", view: "text" },
      { view: "decrement", label: false },
      { attr: "quantity", label: 'Qty', view: "qty" },
      { view: "increment", label: false },
      { view: "remove", text: "Hapus", label: false }
    ],
    currency: "IDR",
  });

  // AI Chat State
  let currentProduct = null;
  let chatHistory = [];
  const AI_API_URL = 'https://ai-plus62store.sendaljepit.workers.dev/api/chat';

  // Helper: Parse harga "20.000" ke 20000
  function parsePrice(priceStr) {
    if (typeof priceStr === 'number') return priceStr;
    if (!priceStr) return 0;
    return parseInt(priceStr.toString().replace(/\./g, '')) || 0;
  }

  // Helper: Format harga untuk display
  function formatPrice(price) {
    if (typeof price === 'string') return price;
    return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  // Load products
  async function loadProducts() {
    try {
      const res = await fetch('https://plus62store.github.io/products.json');
      const data = await res.json();

      const container = document.getElementById('productGrid');
      container.innerHTML = '';

      data.product.forEach(item => {
        const card = document.createElement('div');
        card.className = 'product-card';
        
        const stockColor = item.stok === 'Stok Habis' ? '#e74c3c' : '#27ae60';
        const stockText = item.stok === 'Stok Habis' ? 'Stok Habis' : 'Tersedia';

        card.innerHTML = `
          <img class="product-image" src="${item.image}" alt="${item.title}" loading="lazy" />
          <div class="product-title">${item.title}</div>
          <div class="product-price">
            ${item.price ? `<span style="text-decoration: line-through; color: #999; margin-right: 8px;">
              Rp ${formatPrice(item.price)}
            </span>` : ''}
            <span style="font-weight: bold; color: #e74c3c;">
              Rp ${formatPrice(item.discount)}
            </span>
          </div>
          <div class="product-stock" style="color: ${stockColor}">
            ${stockText}
          </div>
        `;

        card.addEventListener('click', () => openProductChat(item));
        container.appendChild(card);
      });

      updateCartCount();
    } catch (err) {
      console.error('Gagal memuat produk:', err);
      const container = document.getElementById('productGrid');
      container.innerHTML = '<p style="text-align:center;color:red;">Gagal memuat data produk.</p>';
    }
  }

  // Open chat for specific product
  function openProductChat(product) {
    currentProduct = product;
    chatHistory = [];
    
    const modal = document.getElementById('chat-modal');
    const title = document.getElementById('chat-title');
    const messages = document.getElementById('chat-messages');
    
    title.textContent = `ğŸ¤– AI Assistant - ${product.title}`;
    messages.innerHTML = '';
    
    // Initial AI message - beri konteks produk
    const colors = product.styles?.map(s => s.name).join(', ') || 'berbagai pilihan';
    const price = formatPrice(product.discount);
    
    addMessage('ai', `ğŸ‘‹ **Halo! Saya AI Assistant GPT khusus untuk ${product.title}.** 
    
**ğŸ“Š Detail Produk:**
â€¢ ğŸ’° **Harga:** Rp ${price}
â€¢ ğŸ“¦ **Stok:** ${product.stok}
â€¢ ğŸ¨ **Warna tersedia:** ${colors}
â€¢ ğŸ€ **Model tali:** Regular, Panjang, Pendek

**ğŸ’¡ Cara berinteraksi dengan saya:**
1. Tanya detail produk: "Berapa harganya?", "Apa warnanya?"
2. Cek ketersediaan: "Stok masih ada?", "Warna merah ada?"
3. Mulai belanja: "Saya mau beli warna hitam 2 pcs"
4. Tanya apapun tentang produk ini!

**Contoh pesan:**
â€¢ "Berapa harga diskonnya?"
â€¢ "Saya mau warna navy 3 buah"
â€¢ "Model tali panjang ada?"
â€¢ "Tambah ke keranjang 1 pcs warna merah"

_Saya siap membantu Anda! Apa yang ingin Anda tanyakan atau pesan?_ ğŸ›ï¸`);
    
    modal.present();
  }

  // Add message to chat
  function addMessage(sender, text) {
    const messages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    messageDiv.innerHTML = text.replace(/\n/g, '<br>');
    messages.appendChild(messageDiv);
    messages.scrollTop = messages.scrollHeight;
  }

  // Show typing indicator
  function showTyping() {
    const messages = document.getElementById('chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.id = 'typing-indicator';
    typingDiv.innerHTML = `
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    `;
    messages.appendChild(typingDiv);
    messages.scrollTop = messages.scrollHeight;
  }

  // Hide typing indicator
  function hideTyping() {
    const typing = document.getElementById('typing-indicator');
    if (typing) typing.remove();
  }

  // Send message to GPT AI
  async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessage('user', message);
    input.value = '';
    
    // Show typing indicator
    showTyping();
    
    try {
      // Prepare cart data
      const cartData = getCartData();
      
      // Call GPT AI
      const response = await fetch(AI_API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: message,
          productId: currentProduct?.id,
          context: {
            cart: cartData,
            currentProduct: currentProduct,
            userPreferences: {}
          }
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const aiResponse = await response.json();
      hideTyping();
      
      // Add AI response
      if (aiResponse.response) {
        addMessage('ai', aiResponse.response);
      }
      
      // Handle actions
      if (aiResponse.action === 'addToCart' && aiResponse.data) {
        handleAddToCart(aiResponse.data);
      } else if (aiResponse.action === 'ask') {
        // GPT minta informasi tambahan
        addMessage('ai', `${aiResponse.response}\n\nSilakan jawab di chat ya!`);
      }
      
      // Save to history
      chatHistory.push({
        role: 'user',
        content: message
      }, {
        role: 'assistant',
        content: aiResponse.response
      });
      
    } catch (error) {
      hideTyping();
      console.error('GPT AI Error:', error);
      
      // Fallback to local AI
      handleLocalAIResponse(message);
    }
  }

  // Handle add to cart from GPT
  function handleAddToCart(itemData) {
    try {
      // Parse price if it's string
      const price = parsePrice(itemData.price);
      
      simpleCart.add({
        name: itemData.name || currentProduct.title,
        price: price,
        quantity: itemData.quantity || 1,
        warna: itemData.warna || 'Belum dipilih',
        ukuran: itemData.ukuran || 'regular',
        link: itemData.link || currentProduct.url || '#',
        berat: itemData.berat || 100
      });
      
      updateCartCount();
      
      // Show success in chat
      addMessage('ai', `âœ… **Berhasil ditambahkan ke keranjang!** 
      
ğŸ“¦ **Produk:** ${itemData.name || currentProduct.title}
ğŸ¨ **Warna:** ${itemData.warna || 'Belum dipilih'}
ğŸ“ **Model:** ${itemData.ukuran || 'regular'}
ğŸ”¢ **Jumlah:** ${itemData.quantity || 1} pcs
ğŸ’° **Subtotal:** Rp ${formatPrice(price * (itemData.quantity || 1))}

ğŸ›’ **Keranjang Anda sekarang:** ${simpleCart.quantity()} item
ğŸ’³ **Total sementara:** Rp ${formatPrice(simpleCart.total())}

Ingin tambah produk lain atau lanjut ke checkout?`);
      
    } catch (error) {
      console.error('Error adding to cart:', error);
      addMessage('ai', 'âŒ **Gagal menambahkan ke keranjang.** Silakan coba lagi atau hubungi admin.');
    }
  }

  // Local AI fallback (if GPT fails)
  function handleLocalAIResponse(message) {
    const lowerMsg = message.toLowerCase();
    
    if (lowerMsg.includes('harga') || lowerMsg.includes('berapa')) {
      addMessage('ai', `ğŸ’° **Harga ${currentProduct.title}:**
â€¢ Harga asli: Rp ${formatPrice(currentProduct.price)}
â€¢ **Harga diskon:** Rp ${formatPrice(currentProduct.discount)}
â€¢ Anda hemat: Rp ${formatPrice(parsePrice(currentProduct.price) - parsePrice(currentProduct.discount))}!`);
    }
    else if (lowerMsg.includes('warna') || lowerMsg.includes('color')) {
      const colors = currentProduct.styles?.map(s => `â€¢ ${s.name}`).join('<br>') || 'Tidak ada info warna';
      addMessage('ai', `ğŸ¨ **Warna yang tersedia untuk ${currentProduct.title}:**
<br>${colors}
<br><br>Pilih warna favorit Anda!`);
    }
    else if (lowerMsg.includes('stok') || lowerMsg.includes('ada') || lowerMsg.includes('tersedia')) {
      addMessage('ai', `ğŸ“¦ **Status stok ${currentProduct.title}:**
<br>â€¢ **${currentProduct.stok}**
<br>${currentProduct.stok === 'Stok Habis' ? 'ğŸ˜” Maaf, stok sedang habis. Cek produk lain ya!' : 'âœ… Siap dikirim! Pesan sekarang!'}`);
    }
    else if (lowerMsg.includes('beli') || lowerMsg.includes('pesan') || lowerMsg.includes('tambah') || lowerMsg.includes('cart')) {
      addMessage('ai', `ğŸ›’ **Mau beli ${currentProduct.title}?**
<br><br>**Langkah pemesanan:**
<br>1. **Pilih warna** (contoh: "hitam", "navy", "merah")
<br>2. **Tentukan jumlah** (contoh: "2 pcs", "3 buah")
<br>3. **Pilih model tali** (regular/panjang/pendek)
<br><br>**Contoh pesan lengkap:**
<br>"Saya mau warna hitam 2 pcs model regular"
<br>"Pesan warna merah 1 buah tali panjang"
<br>"Beli navy 3 pcs"
<br><br>Silakan tulis pesan Anda!`);
    }
    else {
      addMessage('ai', `ğŸ¤– **AI Assistant untuk ${currentProduct.title}**
<br><br>Saya bisa bantu Anda dengan:
<br>â€¢ **ğŸ’° Harga** - Tanya harga dan diskon
<br>â€¢ **ğŸ¨ Warna** - Lihat pilihan warna
<br>â€¢ **ğŸ“¦ Stok** - Cek ketersediaan
<br>â€¢ **ğŸ›’ Pemesanan** - Bantu beli produk
<br>â€¢ **â“ Lainnya** - Pertanyaan apapun!
<br><br>Coba tanya: "Berapa harganya?" atau "Saya mau beli..."`);
    }
  }

  // Get cart data for AI context
  function getCartData() {
    try {
      const items = simpleCart.items();
      return items.map(item => ({
        name: item.get('name'),
        price: item.get('price'),
        quantity: item.get('quantity'),
        warna: item.get('warna'),
        ukuran: item.get('ukuran'),
        total: item.get('price') * item.get('quantity')
      }));
    } catch (error) {
      return [];
    }
  }

  // Update cart count
  function updateCartCount() {
    try {
      const count = simpleCart.quantity();
      const cartCount = document.getElementById('cart-count');
      if (cartCount) {
        cartCount.textContent = count;
      }
    } catch (error) {
      // Silent error
    }
  }

  // Checkout function
  function checkout() {
    const cartModal = document.getElementById('cart-modal');
    cartModal.dismiss();
    
    if (simpleCart.quantity() === 0) {
      alert('Keranjang belanja kosong!');
      return;
    }
    
    // Use existing WhatsApp order from formOrder.js
    if (typeof WhatsApp === 'function') {
      WhatsApp();
    } else {
      // Fallback WhatsApp
      const total = simpleCart.total();
      const items = simpleCart.items().map(item => 
        `${item.get('name')} - ${item.get('quantity')} pcs (${item.get('warna')})`
      ).join('\n');
      
      const message = `Halo, saya mau order:\n\n${items}\n\nTotal: Rp ${formatPrice(total)}`;
      const phone = '6281234567890'; // Ganti dengan nomor admin
      const encoded = encodeURIComponent(message);
      window.open(`https://wa.me/${phone}?text=${encoded}`, '_blank');
    }
  }

  // Close chat
  function closeChat() {
    const modal = document.getElementById('chat-modal');
    if (modal) modal.dismiss();
    currentProduct = null;
    chatHistory = [];
  }

  // Close cart
  function closeCart() {
    const modal = document.getElementById('cart-modal');
    if (modal) modal.dismiss();
  }

  // Enter key support
  document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
    }
    
    // Initialize
    loadProducts();
    
    // Update cart on changes
    if (typeof simpleCart !== 'undefined') {
      simpleCart.bind('update', updateCartCount);
    }
    
    // Initial greeting
    setTimeout(() => {
      const messages = document.getElementById('chat-messages');
      if (messages && messages.children.length === 0) {
        addMessage('ai', `ğŸ¤– **Selamat datang di AI Shopping Assistant!**
<br><br>Saya menggunakan **GPT-20B** untuk membantu Anda berbelanja.
<br><br>**Cara menggunakan:**
<br>1. ğŸ‘† **Klik produk** untuk mulai chat
<br>2. ğŸ’¬ **Tanya apapun** tentang produk
<br>3. ğŸ›’ **Beli langsung** lewat chat
<br>4. ğŸ“± **Checkout** via WhatsApp
<br><br>Klik produk untuk mulai! ğŸ‰`);
      }
    }, 1500);
  });

  // WhatsApp integration
  window.WhatsAppOrder = function() {
    alert('Fitur WhatsApp checkout akan terbuka setelah Anda konfirmasi.');
  };
</script>
</body>
</html>