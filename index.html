<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Toko Masker Online - AI Assistant</title>

  <!-- Ionic Core v8 via CDN -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@8/dist/ionic/ionic.esm.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@8/dist/ionic/ionic.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core@8/css/ionic.bundle.css" />
  
  <!-- Include SimpleCart -->
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
  <script src="./simpleCart.js"></script>
  <script src="./main.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .product-grid {
      display: grid;
      gap: 16px;
      padding: 16px;
      grid-template-columns: repeat(2, 1fr);
    }

    @media (min-width: 768px) {
      .product-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .product-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }

    .product-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .product-image {
      width: 100%;
      height: 160px;
      object-fit: cover;
    }

    .product-title {
      font-size: 14px;
      font-weight: 600;
      padding: 8px 12px 4px;
    }

    .product-price {
      font-size: 14px;
      color: #e74c3c;
      padding: 0 12px 8px;
    }

    .product-stock {
      font-size: 12px;
      padding: 0 12px 8px;
    }

    /* Chat Modal Styles */
    .chat-container {
      height: 400px;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #f5f5f5;
    }

    .message {
      margin-bottom: 12px;
      max-width: 80%;
    }

    .user-message {
      margin-left: auto;
      background: #3880ff;
      color: white;
      padding: 10px 14px;
      border-radius: 18px 18px 4px 18px;
    }

    .ai-message {
      margin-right: auto;
      background: white;
      color: #333;
      padding: 10px 14px;
      border-radius: 18px 18px 18px 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .chat-input {
      display: flex;
      padding: 16px;
      border-top: 1px solid #ddd;
      background: white;
    }

    .chat-input ion-input {
      flex: 1;
      margin-right: 12px;
    }

    /* Loading indicator */
    .typing-indicator {
      display: flex;
      padding: 10px 14px;
      background: white;
      border-radius: 18px;
      width: fit-content;
      margin-bottom: 12px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      margin: 0 2px;
      background: #ccc;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <ion-app>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Toko Masker Online</ion-title>
        <ion-buttons slot="end">
          <ion-button id="cart-button">
            <ion-icon name="cart" slot="icon-only"></ion-icon>
            <ion-badge color="danger" id="cart-count">0</ion-badge>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <div class="product-grid" id="productGrid"></div>
    </ion-content>
<span id="footer">DaffaDev</span>
    <!-- AI Chat Modal -->
    <ion-modal trigger="open-chat" id="chat-modal">
      <ion-header>
        <ion-toolbar>
          <ion-title id="chat-title">AI Shopping Assistant</ion-title>
          <ion-buttons slot="end">
            <ion-button onclick="closeChat()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <div class="chat-container">
          <div class="chat-messages" id="chat-messages">
            <!-- Messages will be inserted here -->
          </div>
          <div class="chat-input">
            <ion-input 
              id="chat-input" 
              placeholder="Tanyakan tentang produk..."
              enterkeyhint="send"
            ></ion-input>
            <ion-button id="send-button" onclick="sendMessage()">
              <ion-icon name="send" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ion-modal>

    <!-- Cart Modal -->
    <ion-modal trigger="cart-button" id="cart-modal">
      <ion-header>
        <ion-toolbar>
          <ion-title>Keranjang Belanja</ion-title>
          <ion-buttons slot="end">
            <ion-button onclick="closeCart()">Tutup</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <div id="simpleCart_items" class="simpleCart_items"></div>
        <ion-grid>
          <ion-row>
            <ion-col>
              <ion-button expand="block" color="success" onclick="checkout()">
                Checkout
                <ion-icon name="arrow-forward" slot="end"></ion-icon>
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-content>
    </ion-modal>
  </ion-app>
<script>
  // Konfigurasi SimpleCart
  simpleCart({
    cartColumns: [
      { attr: "name", label: "Produk", view: "link" },
      { attr: "price", label: "Harga", view: "currency" },
      { attr: "warna", label: "Warna", view: "text" },
      { attr: "ukuran", label: "Model", view: "text" },
      { view: "decrement", label: false },
      { attr: "quantity", label: 'Qty', view: "qty" },
      { view: "increment", label: false },
      { view: "remove", text: "âœ• Hapus", label: false }
    ],
    currency: "IDR",
  });

  // AI Chat State
  let currentProduct = null;
  let chatHistory = [];
  const AI_API_URL = 'https://ai-plus62store.sendaljepit.workers.dev/api/chat';

  // Format harga
  function parsePrice(priceStr) {
    if (!priceStr) return 0;
    return parseInt(priceStr.toString().replace(/\./g, '')) || 0;
  }

  function formatPrice(price) {
    if (typeof price === 'string') return price;
    return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  // Load products
  async function loadProducts() {
    try {
      const res = await fetch('https://plus62store.github.io/products.json');
      const data = await res.json();

      const container = document.getElementById('productGrid');
      container.innerHTML = '';

      data.product.forEach(item => {
        const card = document.createElement('div');
        card.className = 'product-card';
        
        const stockColor = item.stok === 'Stok Habis' ? '#e74c3c' : '#27ae60';
        const stockText = item.stok === 'Stok Habis' ? 'ðŸ˜” Stok Habis' : 'âœ… Tersedia';
        const discount = parsePrice(item.discount);
        const original = parsePrice(item.price);
        const save = original - discount;

        card.innerHTML = `
          <img class="product-image" src="${item.image}" alt="${item.title}" loading="lazy" 
               onerror="this.src='https://via.placeholder.com/300x200?text=ðŸ›’+Masker+Online'" />
          <div class="product-title">${item.title}</div>
          <div class="product-price">
            <span style="color: #e74c3c; font-weight: bold;">
              Rp ${formatPrice(item.discount)}
            </span>
            ${save > 0 ? `<div style="font-size: 11px; color: #2ecc71;">Hemat Rp ${formatPrice(save)}!</div>` : ''}
          </div>
          <div class="product-stock" style="color: ${stockColor}">
            ${stockText}
          </div>
          <div style="padding: 0 12px 8px; font-size: 11px; color: #666;">
            ðŸ’¬ Chat Maya untuk tanya/beli
          </div>
        `;

        card.addEventListener('click', () => {
          console.log('Opening chat for:', item.title);
          openProductChat(item);
        });
        
        container.appendChild(card);
      });

      updateCartCount();
      
    } catch (err) {
      console.error('Gagal memuat produk:', err);
      const container = document.getElementById('productGrid');
      container.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
          <div style="font-size: 48px;">ðŸ˜•</div>
          <p style="color: #666; margin-top: 16px;">Gagal memuat produk</p>
          <button onclick="loadProducts()" style="margin-top: 16px; padding: 10px 20px; background: #3880ff; color: white; border: none; border-radius: 8px;">
            ðŸ”„ Coba Lagi
          </button>
        </div>
      `;
    }
  }

  // Open chat - SUPER FRIENDLY VERSION
  function openProductChat(product) {
    currentProduct = product;
    chatHistory = [];
    
    const modal = document.getElementById('chat-modal');
    const title = document.getElementById('chat-title');
    const messages = document.getElementById('chat-messages');
    
    title.innerHTML = `ðŸ’¬ Maya - ${product.title}`;
    messages.innerHTML = '';
    
    // Welcome message yang sangat friendly
    const colors = product.styles?.map(s => s.name).join(', ') || 'beragam warna cakep';
    const discountPrice = formatPrice(product.discount);
    const originalPrice = formatPrice(product.price);
    const saveAmount = parsePrice(product.price) - parsePrice(product.discount);
    
    const welcomeMessage = `Hai kak! ðŸ‘‹ Aku Maya, asisten belanja kamu di Plus62 Store! ðŸ˜Š

Aku liat kamu lagi liat **${product.title}** nih. Good choice! ðŸ‘Œ

**Quick info buat kamu:**
ðŸ’° **Harga:** Rp ${discountPrice} *(dulu Rp ${originalPrice}, hemat Rp ${formatPrice(saveAmount)} lho!)*
ðŸŽ¨ **Warna:** ${colors}
ðŸ“¦ **Stok:** ${product.stok === 'Stok Habis' ? 'ðŸ˜­ Lagi kosong nih, cek produk lain ya!' : 'âœ… Masih ada, yuk langsung!'}
ðŸ“ **Tali:** Bisa pilih regular / panjang / pendek

Gimana kak? Mau tanya apa aja soal produk ini? Atau langsung mau pesan? Aku siap bantu! ðŸ’â€â™€ï¸

*Contoh chat sama aku:*
â€¢ "Warnanya ada yg item gak?"
â€¢ "Aku mau yg warna navy 3 biji dong"
â€¢ "Model tali panjangnya gimana sih?"
â€¢ "Ceritain dong kelebihan masker ini"
â€¢ "Langsung masukin ke keranjang aja yg warna krem 2 pcs"`;

    addMessage('ai', welcomeMessage);
    
    modal.present();
    
    // Auto focus ke input
    setTimeout(() => {
      const input = document.getElementById('chat-input');
      if (input) input.focus();
    }, 300);
  }

  // Add message dengan styling lebih baik
  function addMessage(sender, text) {
    const messages = document.getElementById('chat-messages');
    if (!messages) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    // Format text: line breaks, bold with **, emoji support
    let formattedText = text
      .replace(/\n/g, '<br>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Add sender label
    const senderLabel = sender === 'ai' 
      ? '<div style="font-size: 11px; color: #666; margin-bottom: 4px;">ðŸ¤– Maya</div>' 
      : '<div style="font-size: 11px; color: #666; margin-bottom: 4px;">ðŸ‘¤ Kamu</div>';
    
    messageDiv.innerHTML = senderLabel + formattedText;
    messages.appendChild(messageDiv);
    messages.scrollTop = messages.scrollHeight;
  }

  // Typing indicator yang lebih cute
  function showTyping() {
    const messages = document.getElementById('chat-messages');
    if (!messages) return;
    
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai-message';
    typingDiv.id = 'typing-indicator';
    typingDiv.innerHTML = `
      <div style="font-size: 11px; color: #666; margin-bottom: 4px;">ðŸ¤– Maya sedang mengetik...</div>
      <div style="display: flex; align-items: center;">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    `;
    messages.appendChild(typingDiv);
    messages.scrollTop = messages.scrollHeight;
  }

  function hideTyping() {
    const typing = document.getElementById('typing-indicator');
    if (typing) typing.remove();
  }

  // Send message - MAIN CHAT FUNCTION
  async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessage('user', message);
    input.value = '';
    
    // Show typing indicator
    showTyping();
    
    try {
      // Prepare context
      const cartData = simpleCart.items().map(item => ({
        name: item.get('name'),
        price: item.get('price'),
        quantity: item.get('quantity'),
        warna: item.get('warna'),
        ukuran: item.get('ukuran')
      }));
      
      console.log('Sending to AI:', { message, product: currentProduct?.title });
      
      // Call AI
      const response = await fetch(AI_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: message,
          productId: currentProduct?.id,
          context: { cart: cartData }
        })
      });
      
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const aiResponse = await response.json();
      hideTyping();
      
      console.log('AI Response:', aiResponse);
      
      // Add AI response
      if (aiResponse.response) {
        addMessage('ai', aiResponse.response);
      }
      
      // Handle actions
      if (aiResponse.action?.type === 'addToCart' && aiResponse.action.data) {
        handleAddToCart(aiResponse.action.data);
      }
      
      // Save to history
      chatHistory.push({ user: message, ai: aiResponse.response });
      
    } catch (error) {
      hideTyping();
      console.error('Chat error:', error);
      
      // Fallback: Maya still responds even when API is down
      const fallbackResponses = [
        `Wah sorry kak, koneksi aku lagi agak lemot nih ðŸ˜… Tapi tetep semangat bantu kamu! Coba tanya yang lain atau langsung aja bilang mau beli warna apa berapa pcs! ðŸ’ª`,
        `Oops, jaringan lagi ngambek nih kayanya ðŸ˜¬ Tapi gak papa, Maya tetap di sini! Mau tanya apa lagi soal ${currentProduct?.title}? Atau langsung pesan aja? ðŸ˜Š`,
        `Hmm kayanya server lagi istirahat dikit nih ðŸ˜´ Tapi aku Maya masih siap kok! Coba chat lagi atau langsung aja kasih tau mau pesan yang mana ðŸ˜„`
      ];
      
      const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
      addMessage('ai', randomResponse);
    }
  }

  // Handle add to cart dengan feedback yang fun
  function handleAddToCart(itemData) {
    try {
      const price = parsePrice(itemData.price);
      const quantity = itemData.quantity || 1;
      const warna = itemData.warna || 'pilihan kamu';
      const ukuran = itemData.ukuran || 'regular';
      const productName = itemData.name || currentProduct?.title;
      
      // Add to cart
      simpleCart.add({
        name: productName,
        price: price,
        quantity: quantity,
        warna: warna,
        ukuran: ukuran,
        link: currentProduct?.url || '#',
        berat: 100
      });
      
      updateCartCount();
      
      // Calculate totals
      const subtotal = price * quantity;
      const cartTotal = simpleCart.quantity();
      const cartValue = simpleCart.total();
      
      // Fun success messages
      const successMessages = [
        `ðŸŽ‰ **Yes! Berhasil masuk keranjang!** ${quantity}x ${productName} (${warna}) udah aku tambahin nih!`,
        `âœ… **Done!** ${productName} warna ${warna} udah di keranjang! Mau tambah lagi atau checkout?`,
        `ðŸ›’ **Keranjang updated!** ${productName} masuk! Sekarang ada ${cartTotal} item di keranjang kamu ðŸ˜Š`,
        `âœ¨ **Nice choice!** ${productName} (${warna}) added! Subtotal: Rp ${formatPrice(subtotal)}`
      ];
      
      const randomMsg = successMessages[Math.floor(Math.random() * successMessages.length)];
      addMessage('ai', `${randomMsg}<br><br>ðŸ’° **Total keranjang:** Rp ${formatPrice(cartValue)}<br>ðŸ“¦ **Item total:** ${cartTotal} produk`);
      
    } catch (error) {
      console.error('Add to cart error:', error);
      addMessage('ai', `ðŸ˜… Ups, ada error nih waktu mau masukin ke keranjang. Coba lagi ya kak!`);
    }
  }

  // Update cart count
  function updateCartCount() {
    try {
      const count = simpleCart.quantity();
      const cartCount = document.getElementById('cart-count');
      if (cartCount) {
        cartCount.textContent = count;
        // Add animation
        cartCount.style.transform = 'scale(1.2)';
        setTimeout(() => cartCount.style.transform = 'scale(1)', 300);
      }
    } catch (error) {
      // Silent error
    }
  }

  // Enter key support dengan sound effect (optional)
  document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // Auto-expand textarea
      chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });
    }
    
    // Send button click
    const sendBtn = document.getElementById('send-button');
    if (sendBtn) {
      sendBtn.addEventListener('click', sendMessage);
    }
  });

  // Initialize dengan animasi
  document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ›ï¸ Plus62 Store loading...');
    
    // Load products after a slight delay
    setTimeout(() => {
      loadProducts();
    }, 500);
    
    // Cart updates
    if (typeof simpleCart !== 'undefined') {
      simpleCart.bind('update', updateCartCount);
    }
    
    // Auto greeting setelah modal dibuka
    const modal = document.getElementById('chat-modal');
    if (modal) {
      modal.addEventListener('ionModalDidPresent', () => {
        if (!currentProduct) {
          setTimeout(() => {
            const messages = document.getElementById('chat-messages');
            if (messages && messages.children.length === 0) {
              addMessage('ai', `Halo! ðŸ‘‹ Aku Maya, asisten virtual kamu di Plus62 Store! ðŸ˜Š

Klik produk dulu ya buat mulai ngobrol, nanti aku bantu pilih masker yang cocok buat kamu!

Ada yang bisa aku bantu? ðŸ›ï¸ðŸ’â€â™€ï¸`);
            }
          }, 300);
        }
      });
    }
  });

  // WhatsApp integration yang lebih smooth
  window.WhatsAppOrder = function() {
    const items = simpleCart.items();
    if (items.length === 0) {
      alert('Keranjang masih kosong nih, yuk isi dulu! ðŸ˜Š');
      return;
    }
    
    let message = `Halo Admin Plus62 Store! ðŸ˜Š\nSaya mau order nih:\n\n`;
    
    items.forEach((item, index) => {
      message += `${index + 1}. ${item.get('name')}\n`;
      message += `   Warna: ${item.get('warna') || '-'}\n`;
      message += `   Model: ${item.get('ukuran') || 'regular'}\n`;
      message += `   Jumlah: ${item.get('quantity')} pcs\n`;
      message += `   Harga: Rp ${formatPrice(item.get('price'))}\n\n`;
    });
    
    message += `Total: Rp ${formatPrice(simpleCart.total())}\n\n`;
    message += `*Mohon diproses ya!* ðŸ™`;
    
    const phone = '6281234567890'; // Ganti dengan nomor admin beneran
    const encoded = encodeURIComponent(message);
    window.open(`https://wa.me/${phone}?text=${encoded}`, '_blank');
  };

  // Quick add to cart function (for testing)
  window.quickAdd = function(productName, color, qty) {
    const product = Array.from(document.querySelectorAll('.product-card'))
      .find(card => card.querySelector('.product-title')?.textContent.includes(productName));
    
    if (product) {
      const price = parsePrice(product.dataset.price || '15000');
      simpleCart.add({
        name: productName,
        price: price,
        quantity: qty || 1,
        warna: color || 'hitam',
        ukuran: 'regular',
        berat: 100
      });
      
      updateCartCount();
      alert(`âœ… ${qty || 1} ${productName} warna ${color} ditambahkan!`);
    }
  };
</script>
</body>
</html>